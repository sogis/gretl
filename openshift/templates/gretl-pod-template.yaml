apiVersion: template.openshift.io/v1
kind: Template
labels:
  app: gretl-platform
metadata:
  name: gretl-platform
objects:
- apiVersion: image.openshift.io/v1
  kind: ImageStream
  metadata:
    name: jenkins-agent
  spec:
    lookupPolicy:
      local: true
    tags:
    - from:
        kind: DockerImage
        name: quay.io/openshift/origin-jenkins-agent-base:${JENKINS_AGENT_IMAGE_TAG}
      name: ${JENKINS_AGENT_IMAGE_TAG}
      importPolicy:
        scheduled: ${{JENKINS_AGENT_IMAGE_IMPORT_POLICY_SCHEDULED}}
- apiVersion: image.openshift.io/v1
  kind: ImageStream
  metadata:
    name: gretl
  spec:
    lookupPolicy:
      local: true
    tags:
    - from:
        kind: DockerImage
        name: sogis/gretl:${GRETL_IMAGE_TAG}
      name: ${GRETL_IMAGE_TAG}
      importPolicy:
        scheduled: ${{GRETL_IMAGE_IMPORT_POLICY_SCHEDULED}}
- apiVersion: v1
  kind: ConfigMap
  metadata:
    name: gretl-pod-template
    labels:
      app: gretl-platform
      role: jenkins-slave
  data:
    template: |-
      <org.csanchez.jenkins.plugins.kubernetes.PodTemplate>
        <inheritFrom></inheritFrom>
        <name>gretl</name>
        <instanceCap>4</instanceCap>
        <idleMinutes>0</idleMinutes>
        <label>gretl</label>
        <serviceAccount>jenkins</serviceAccount>
        <nodeSelector></nodeSelector>
        <containers>
          <org.csanchez.jenkins.plugins.kubernetes.ContainerTemplate>
            <name>jnlp</name>
            <image>jenkins-agent:${JENKINS_AGENT_IMAGE_TAG}</image>
            <privileged>false</privileged>
            <alwaysPullImage>false</alwaysPullImage>
            <workingDir>/tmp</workingDir>
            <command></command>
            <args>${computer.jnlpmac} ${computer.name}</args>
            <ttyEnabled>false</ttyEnabled>
            <envVars/>
          </org.csanchez.jenkins.plugins.kubernetes.ContainerTemplate>
          <org.csanchez.jenkins.plugins.kubernetes.ContainerTemplate>
            <name>gretl</name>
            <image>gretl:${GRETL_IMAGE_TAG}</image>
            <privileged>false</privileged>
            <alwaysPullImage>false</alwaysPullImage>
            <workingDir>/tmp</workingDir>
            <command>sleep</command>
            <args>24h</args>
            <ttyEnabled>false</ttyEnabled>
            <envVars>
              <org.csanchez.jenkins.plugins.kubernetes.model.KeyValueEnvVar>
                <key>HOME</key>
                <value>/home/gradle</value>
              </org.csanchez.jenkins.plugins.kubernetes.model.KeyValueEnvVar>
              <org.csanchez.jenkins.plugins.kubernetes.model.KeyValueEnvVar>
                <key>GRADLE_OPTS</key>
                <value>-Xmx1024m</value>
              </org.csanchez.jenkins.plugins.kubernetes.model.KeyValueEnvVar>
            </envVars>
          </org.csanchez.jenkins.plugins.kubernetes.ContainerTemplate>
        </containers>
        <envVars/>
        <annotations/>
        <imagePullSecrets/>
        <nodeProperties/>
        <yaml>
      spec:
        containers:
        - name: jnlp
          resources:
            requests:
              cpu: 200m
              memory: 256Mi
            limits:
              cpu: "1"
              memory: 512Mi
        - name: gretl
          resources:
            requests:
              cpu: 200m
              memory: 1Gi
            limits:
              cpu: "1"
              memory: 3.5Gi
          envFrom:
            - configMapRef:
                name: gretl-resources
            - secretRef:
                name: gretl-secrets
        </yaml>
      </org.csanchez.jenkins.plugins.kubernetes.PodTemplate>
parameters:
- name: JENKINS_AGENT_IMAGE_TAG
  description: Jenkins agent image tag to be pulled from Quay.io
  required: true
- name: JENKINS_AGENT_IMAGE_IMPORT_POLICY_SCHEDULED
  description: Regularly check for changed Jenkins agent image; set to 'true' as it seems that Quay.io immediately deletes any image that has no more tag
  value: 'true'
- name: GRETL_IMAGE_TAG
  description: GRETL image tag to be pulled from Docker Hub
  required: true
- name: GRETL_IMAGE_IMPORT_POLICY_SCHEDULED
  description: Regularly check for changed GRETL image
  value: 'false'
